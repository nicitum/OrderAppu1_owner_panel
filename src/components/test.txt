import React, { useState, useEffect, useRef } from "react";
import {
  getProducts,
  addProduct,
  updateProductsByBrand,
  updateProduct,
  globalPriceUpdate,
  uploadProductImage,
  getImageUrl,
  fetchProductImage,
  readLocalFile
} from "../services/api";
import { Plus, Edit, Package, Image as ImageIcon, Upload } from "lucide-react";
import toast from "react-hot-toast";
import axios from "axios";
import * as XLSX from 'xlsx';

// Placeholder image as a data URL
const placeholderImage = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23f0f0f0"/%3E%3Ctext x="50" y="50" font-size="12" text-anchor="middle" fill="%23666"%3ENo Image%3C/text%3E%3C/svg%3E';

export default function ProductsTab() {
  const [products, setProducts] = useState([]);
  const [brands, setBrands] = useState([]);
  const [categories, setCategories] = useState([]);
  const [selectedBrand, setSelectedBrand] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("");
  const [showAddModal, setShowAddModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showProductEditModal, setShowProductEditModal] = useState(false);
  const [showImageChangeModal, setShowImageChangeModal] = useState(false);
  const [showBulkUploadModal, setShowBulkUploadModal] = useState(false);
  const [errors, setErrors] = useState({});
  const [productPrefix, setProductPrefix] = useState("");
  const [excelFile, setExcelFile] = useState(null);
  const [uploading, setUploading] = useState(false);

  const [newProduct, setNewProduct] = useState({
    product_code: "",
    name: "",
    brand: "",
    category: "",
    mrp: "",
    selling_price: "",
    hsn_code: "",
    gst_rate: "",
    alias: "",
    part_number: "",
    stock_group: "",
    unit_of_measure: "",
    type_of_supply: "",
    maintain_batches: "",
    stock_quantity: 0
  });
  
  const [currentProduct, setCurrentProduct] = useState({
    id: "",
    product_code: "",
    name: "",
    brand: "",
    category: "",
    mrp: "",
    selling_price: "",
    hsn_code: "",
    gst_rate: "",
    image: "",
    alias: "",
    part_number: "",
    stock_group: "",
    unit_of_measure: "",
    type_of_supply: "",
    maintain_batches: "",
    stock_quantity: 0
  });
  
  const [imageFiles, setImageFiles] = useState({});
  const [loadedImages, setLoadedImages] = useState({});
  const fileInputRef = useRef(null);

  // Fetch product prefix and generate next product code
  const fetchProductPrefix = async () => {
    try {
      const [prefixResponse, productsResponse] = await Promise.all([
        axios.get('http://147.93.110.150:3001/api/client_status/APPU0009'),
        getProducts()
      ]);

      if (prefixResponse.data.success && prefixResponse.data.data.length > 0) {
        const prefix = prefixResponse.data.data[0].product_prefix;
        setProductPrefix(prefix);

        // Find the highest existing product code number
        const prefixProducts = productsResponse.filter(product => 
          product.product_code && product.product_code.startsWith(prefix)
        );
        
        const numbers = prefixProducts.map(product => {
          const num = parseInt(product.product_code.replace(prefix, ''));
          return isNaN(num) ? 0 : num;
        });
        
        const maxNumber = Math.max(0, ...numbers);
        const nextNumber = maxNumber + 1;
        
        // Set the new product code with incremented number
        setNewProduct(prev => ({
          ...prev,
          product_code: `${prefix}${nextNumber.toString().padStart(4, '0')}`
        }));
      }
    } catch (error) {
      console.error("Error fetching product prefix:", error);
      toast.error("Failed to fetch product prefix");
    }
  };

  useEffect(() => {
    fetchProductPrefix();
  }, []);

  // Generate product code with prefix
  const generateProductCode = async () => {
    try {
      // Get all products to find the highest number
      const allProducts = await getProducts();
      
      // Filter products with the given prefix and extract numbers
      const prefixProducts = allProducts.filter(product => product.product_code.startsWith(productPrefix));
      const numbers = prefixProducts.map(product => {
        const num = parseInt(product.product_code.replace(productPrefix, ''));
        return isNaN(num) ? 0 : num;
      });
      
      // Find the highest number and increment by 1
      const maxNumber = Math.max(0, ...numbers);
      const nextNumber = maxNumber + 1;
      
      // Format the number with leading zeros (4 digits)
      return `${productPrefix}${nextNumber.toString().padStart(4, '0')}`;
    } catch (error) {
      console.error("Error generating product code:", error);
      toast.error("Failed to generate product code");
      return `${productPrefix}0001`; // Fallback to 0001 if there's an error
    }
  };

  useEffect(() => {
    fetchProducts();
  }, []);

  useEffect(() => {
    const loadImages = async () => {
      for (const product of products) {
        if (product.image && !loadedImages[product.id]) {
          try {
            // First try the direct URL
            const imageUrl = getImageUrl(product.image);
            if (imageUrl) {
              const img = new Image();
              img.src = imageUrl;
              await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = async () => {
                  try {
                    // If direct URL fails, try fetching through the API
                    const blobUrl = await fetchProductImage(product.image);
                    setLoadedImages(prev => ({
                      ...prev,
                      [product.id]: blobUrl
                    }));
                    resolve();
                  } catch (err) {
                    console.error(`Failed to load image for product ${product.id}:`, err);
                    reject(err);
                  }
                };
              });
            }
          } catch (error) {
            console.error(`Failed to load image for product ${product.id}:`, error);
          }
        }
      }
    };
    loadImages();
  }, [products]);

  const fetchProducts = async () => {
    try {
      const data = await getProducts();
      setProducts(data);
      setBrands([...new Set(data.map((p) => p.brand))]);
      setCategories([...new Set(data.map((p) => p.category))]);
    } catch (error) {
      toast.error("Failed to fetch products");
    }
  };

  const validateForm = (productData) => {
    const errors = {};
    if (!productData.product_code) errors.product_code = "Product Code is required";
    if (!productData.name) errors.name = "Name is required";
    if (!productData.stock_group) errors.stock_group = "Stock Group is required";
    if (!productData.unit_of_measure) errors.unit_of_measure = "Unit of Measure is required";
    if (!productData.gst_rate) errors.gst_rate = "GST Rate is required";
    if (!productData.type_of_supply) errors.type_of_supply = "Type of Supply is required";
    setErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleAddProduct = async (e) => {
    e.preventDefault();
    if (!validateForm(newProduct)) {
      toast.error("Please fill in all required fields");
      return;
    }
    try {
      const productCode = await generateProductCode();
      const currentDate = new Date().toISOString();

      await addProduct({
        product_code: productCode,
        name: newProduct.name,
        brand: newProduct.brand,
        category: newProduct.category,
        price: newProduct.mrp ? parseFloat(newProduct.mrp) : null,
        discountPrice: newProduct.selling_price ? parseFloat(newProduct.selling_price) : null,
        created_at: currentDate,
        updated_at: currentDate,
        hsn_code: newProduct.hsn_code,
        gst_rate: newProduct.gst_rate ? parseFloat(newProduct.gst_rate) : null,
        alias: newProduct.alias,
        part_number: newProduct.part_number,
        stock_group: newProduct.stock_group,
        type_of_supply: newProduct.type_of_supply,
        maintain_batches: newProduct.maintain_batches === "Yes",
        stock_quantity: newProduct.stock_quantity ? parseInt(newProduct.stock_quantity) : 0
      });

      await fetchProducts();
      setShowAddModal(false);
      setNewProduct({
        product_code: "",
        name: "",
        brand: "",
        category: "",
        mrp: "",
        selling_price: "",
        hsn_code: "",
        gst_rate: "",
        alias: "",
        part_number: "",
        stock_group: "",
        unit_of_measure: "",
        type_of_supply: "",
        maintain_batches: "",
        stock_quantity: 0
      });
      setErrors({});
      toast.success("Product added successfully");
    } catch (error) {
      toast.error("Failed to add product");
    }
  };

  const handleEditProduct = async (e) => {
    e.preventDefault();
    if (!validateForm(currentProduct)) {
      toast.error("Please check the form");
      return;
    }
    try {
      const currentDate = new Date().toISOString();
      await updateProduct(currentProduct.id, {
        product_code: currentProduct.product_code,
        name: currentProduct.name,
        brand: currentProduct.brand,
        category: currentProduct.category,
        price: currentProduct.mrp ? parseFloat(currentProduct.mrp) : null,
        discountPrice: currentProduct.selling_price ? parseFloat(currentProduct.selling_price) : null,
        updated_at: currentDate,
        hsn_code: currentProduct.hsn_code,
        gst_rate: currentProduct.gst_rate ? parseFloat(currentProduct.gst_rate) : null,
        alias: currentProduct.alias,
        part_number: currentProduct.part_number,
        stock_group: currentProduct.stock_group,
        unit_of_measure: currentProduct.unit_of_measure,
        type_of_supply: currentProduct.type_of_supply,
        maintain_batches: currentProduct.maintain_batches === "Yes",
        stock_quantity: currentProduct.stock_quantity ? parseInt(currentProduct.stock_quantity) : 0
      });

      if (currentProduct.selling_price) {
        await globalPriceUpdate(
          currentProduct.id,
          parseFloat(currentProduct.selling_price)
        );
      }
      await fetchProducts();
      setShowProductEditModal(false);
      setErrors({});
      toast.success("Product updated successfully");
    } catch (error) {
      toast.error("Failed to update product");
    }
  };

  const handleImageChange = async (e) => {
    e.preventDefault();
    try {
      if (!imageFiles[currentProduct.id]) {
        toast.error("Please select an image file");
        return;
      }

      const formData = new FormData();
      formData.append('image', imageFiles[currentProduct.id]);

      await uploadProductImage(currentProduct.id, imageFiles[currentProduct.id]);
      await fetchProducts();
      setShowImageChangeModal(false);
      setImageFiles({});
      toast.success("Product image updated successfully");
    } catch (error) {
      console.error("Error updating image:", error);
      toast.error("Failed to update product image");
    }
  };

  const handleImageFilesChange = (e) => {
    const files = Array.from(e.target.files);
    const newImageFiles = {};
    
    files.forEach(file => {
      newImageFiles[currentProduct.id] = file;
    });
    
    setImageFiles(prev => ({ ...prev, ...newImageFiles }));
  };

  const handleBulkUpload = async (e) => {
    e.preventDefault();
    if (!excelFile) {
      toast.error("Please select an Excel file");
      return;
    }

    setUploading(true);

    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          for (const row of jsonData) {
            try {
              const currentDate = new Date().toISOString();
              const productData = {
                product_code: row.product_code || await generateProductCode(),
                name: row.name,
                brand: row.brand || "",
                category: row.category || "",
                price: row.mrp ? parseFloat(row.mrp) : null,
                discountPrice: row.selling_price ? parseFloat(row.selling_price) : null,
                created_at: currentDate,
                updated_at: currentDate,
                hsn_code: row.hsn_code || "",
                gst_rate: row.gst_rate ? parseFloat(row.gst_rate) : null,
                alias: row.alias || "",
                part_number: row.part_number || "",
                stock_group: row.stock_group || "",
                type_of_supply: row.type_of_supply || "Goods",
                maintain_batches: row.maintain_batches === "Yes",
                stock_quantity: row.stock_quantity ? parseInt(row.stock_quantity) : 0
              };
              await addProduct(productData);
            } catch {
              // Ignore row errors, continue
            }
          }
          await fetchProducts();
          toast.success("Products uploaded successfully");
          setShowBulkUploadModal(false);
          setExcelFile(null);
          setUploading(false);
        } catch {
          toast.error("Failed to process Excel file");
          setUploading(false);
        }
      };
      reader.readAsArrayBuffer(excelFile);
    } catch {
      toast.error("Failed to read Excel file");
      setUploading(false);
    }
  };

  const downloadTemplate = () => {
    const template = [
      {
        product_code: "AUTO-GENERATED",
        name: "Product Name",
        brand: "Brand Name",
        category: "Category",
        mrp: "1000",
        selling_price: "900",
        hsn_code: "HSN Code",
        gst_rate: "18",
        alias: "Alias",
        part_number: "Part Number",
        stock_group: "Stock Group",
        type_of_supply: "Goods",
        maintain_batches: "Yes",
        stock_quantity: "100",
        image_path: "C:/Users/YourName/Pictures/product-image.jpg or https://example.com/image.jpg"
      }
    ];

    const ws = XLSX.utils.json_to_sheet(template);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "product_upload_template.xlsx");
  };

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-8">
          <h2 className="text-3xl font-bold text-[#003366]">
            Product Management
          </h2>
          <div className="flex space-x-4">
            <button
              onClick={() => setShowBulkUploadModal(true)}
              className="flex items-center px-4 py-2 bg-[#003366] text-white rounded-lg hover:bg-[#002244] transition-colors"
            >
              <Upload className="h-5 w-5 mr-2" />
              Bulk Upload
            </button>
            <button
              onClick={() => setShowAddModal(true)}
              className="flex items-center px-4 py-2 bg-[#003366] text-white rounded-lg hover:bg-[#002244] transition-colors"
            >
              <Plus className="h-5 w-5 mr-2" />
              Add Product
            </button>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-md p-6 mb-8">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Filter by Brand
              </label>
              <select
                value={selectedBrand}
                onChange={(e) => setSelectedBrand(e.target.value)}
                className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
              >
                <option value="">All Brands</option>
                {brands.map((brand) => (
                  <option key={brand} value={brand}>
                    {brand}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Filter by Category
              </label>
              <select
                value={selectedCategory}
                onChange={(e) => setSelectedCategory(e.target.value)}
                className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
              >
                <option value="">All Categories</option>
                {categories.map((category) => (
                  <option key={category} value={category}>
                    {category}
                  </option>
                ))}
              </select>
            </div>
          </div>
          {selectedBrand && (
            <div className="flex justify-end mt-6">
              <button
                onClick={() => setShowEditModal(true)}
                className="px-4 py-2 bg-[#003366] text-white rounded-lg hover:bg-[#002244] transition-colors"
              >
                Edit {selectedBrand} Products
              </button>
            </div>
          )}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {products
            .filter(
              (product) =>
                (!selectedBrand || product.brand === selectedBrand) &&
                (!selectedCategory || product.category === selectedCategory)
            )
            .map((product) => (
              <div
                key={product.id}
                className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
              >
                <div className="mb-4 h-48 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
                  {product.image ? (
                    <img
                      src={loadedImages[product.id] || getImageUrl(product.image)}
                      alt={product.name}
                      className="h-full w-full object-contain"
                      onError={async (e) => {
                        console.log(`Attempting to load image for ${product.name} via API`);
                        try {
                          const blobUrl = await fetchProductImage(product.image);
                          setLoadedImages(prev => ({
                            ...prev,
                            [product.id]: blobUrl
                          }));
                        } catch (err) {
                          console.error(`Failed to load image for ${product.name}:`, err);
                          e.target.onerror = null;
                          e.target.src = placeholderImage;
                        }
                      }}
                    />
                  ) : (
                    <div className="text-gray-400 flex flex-col items-center">
                      <ImageIcon className="h-10 w-10" />
                      <span className="text-sm mt-2">No image available</span>
                    </div>
                  )}
                </div>

                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-[#003366]">
                    {product.name}
                  </h3>
                  <Package className="h-6 w-6 text-gray-400" />
                </div>
                <div className="space-y-2">
                  <p className="text-sm text-gray-600">
                    Brand: {product.brand}
                  </p>
                  <p className="text-sm text-gray-600">
                    Category: {product.category}
                  </p>
                  <p className="text-sm text-gray-600">
                    Product Code: {product.product_code}
                  </p>
                  <p className="text-lg font-bold text-[#003366]">
                    MRP: ₹{product.price}
                  </p>
                  <p className="text-lg font-bold text-red-600">
                    Selling Price: ₹{product.discountPrice}
                  </p>
                </div>
                <div className="mt-4 p-3 bg-gray-50 rounded-lg flex items-center justify-between">
                  <div className="flex items-center">
                    <ImageIcon className="h-5 w-5 text-[#003366] mr-2" />
                    <span className="text-sm text-gray-600">Product Image</span>
                  </div>
                  <button
                    className="text-[#003366] hover:underline text-sm"
                    onClick={() => {
                      setCurrentProduct(product);
                      setShowImageChangeModal(true);
                    }}
                  >
                    Change
                  </button>
                </div>
                <div className="flex justify-end mt-4">
                  <button
                    onClick={() => {
                      setCurrentProduct({
                        ...product,
                        maintain_batches: product.maintain_batches ? "Yes" : "No"
                      });
                      setShowProductEditModal(true);
                    }}
                    className="px-4 py-2 bg-[#003366] text-white rounded-lg hover:bg-[#002244] transition-colors"
                  >
                    <Edit className="h-5 w-5 inline mr-2" />
                    Edit
                  </button>
                </div>
              </div>
            ))}
        </div>

        {/* Add Product Modal */}
        {showAddModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
              <h3 className="text-xl font-semibold text-[#003366] mb-6">
                Add New Product
              </h3>
              <form onSubmit={handleAddProduct} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Product Code *
                    </label>
                    <input
                      type="text"
                      value={newProduct.product_code}
                      disabled
                      className="block w-full rounded-lg border-gray-300 shadow-sm bg-gray-50 text-gray-500 cursor-not-allowed"
                      required
                    />
                    <p className="mt-1 text-sm text-gray-500">Auto-generated field</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Name *
                    </label>
                    <input
                      type="text"
                      value={newProduct.name}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, name: e.target.value })
                      }
                      className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors ${errors.name ? 'border-red-500' : ''}`}
                      required
                    />
                    {errors.name && (
                      <p className="mt-1 text-sm text-red-600">{errors.name}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Brand
                    </label>
                    <input
                      type="text"
                      value={newProduct.brand}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, brand: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Category
                    </label>
                    <input
                      type="text"
                      value={newProduct.category}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, category: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      MRP *
                    </label>
                    <input
                      type="number"
                      value={newProduct.mrp}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, mrp: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Selling Price *
                    </label>
                    <input
                      type="number"
                      value={newProduct.selling_price}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, selling_price: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      HSN Code
                    </label>
                    <input
                      type="text"
                      value={newProduct.hsn_code}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, hsn_code: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      GST Rate *
                    </label>
                    <input
                      type="number"
                      value={newProduct.gst_rate}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, gst_rate: e.target.value })
                      }
                      className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors ${errors.gst_rate ? 'border-red-500' : ''}`}
                      required
                    />
                    {errors.gst_rate && (
                      <p className="mt-1 text-sm text-red-600">{errors.gst_rate}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Stock Group *
                    </label>
                    <input
                      type="text"
                      value={newProduct.stock_group}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, stock_group: e.target.value })
                      }
                      className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors ${errors.stock_group ? 'border-red-500' : ''}`}
                      required
                    />
                    {errors.stock_group && (
                      <p className="mt-1 text-sm text-red-600">{errors.stock_group}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Unit of Measure *
                    </label>
                    <select
                      value={newProduct.unit_of_measure}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, unit_of_measure: e.target.value })
                      }
                      className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors ${errors.unit_of_measure ? 'border-red-500' : ''}`}
                      required
                    >
                      <option value="">Select Unit</option>
                      <option value="PCS">Pieces</option>
                      <option value="KG">Kilograms</option>
                      <option value="LTR">Liters</option>
                      <option value="BOX">Box</option>
                      <option value="PKT">Packet</option>
                      <option value="SET">Set</option>
                    </select>
                    {errors.unit_of_measure && (
                      <p className="mt-1 text-sm text-red-600">{errors.unit_of_measure}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Alias
                    </label>
                    <input
                      type="text"
                      value={newProduct.alias}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, alias: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Part Number
                    </label>
                    <input
                      type="text"
                      value={newProduct.part_number}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, part_number: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Stock Quantity
                    </label>
                    <input
                      type="number"
                      value={newProduct.stock_quantity}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, stock_quantity: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Type of Supply *
                    </label>
                    <select
                      value={newProduct.type_of_supply}
                      onChange={(e) =>
                        setNewProduct({ ...newProduct, type_of_supply: e.target.value })
                      }
                      className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors ${errors.type_of_supply ? 'border-red-500' : ''}`}
                      required
                    >
                      <option value="">Select Type of Supply</option>
                      <option value="Goods">Goods</option>
                      <option value="Services">Services</option>
                    </select>
                    {errors.type_of_supply && (
                      <p className="mt-1 text-sm text-red-600">{errors.type_of_supply}</p>
                    )}
                  </div>
                </div>
                <div className="flex justify-end space-x-3 pt-6">
                  <button
                    type="button"
                    onClick={() => {
                      setShowAddModal(false);
                      setErrors({});
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 text-sm font-medium text-white bg-[#003366] hover:bg-[#002244] rounded-lg transition-colors"
                  >
                    Add Product
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        {/* Edit Product Modal */}
        {showProductEditModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
              <h3 className="text-xl font-semibold text-[#003366] mb-6">
                Edit Product
              </h3>
              <form onSubmit={handleEditProduct} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Product Code
                    </label>
                    <input
                      type="text"
                      value={currentProduct.product_code}
                      disabled
                      className="block w-full rounded-lg border-gray-300 shadow-sm bg-gray-50 text-gray-500 cursor-not-allowed"
                    />
                    <p className="mt-1 text-sm text-gray-500">Auto-generated field</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Name
                    </label>
                    <input
                      type="text"
                      value={currentProduct.name}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, name: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Brand
                    </label>
                    <input
                      type="text"
                      value={currentProduct.brand}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, brand: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Category
                    </label>
                    <input
                      type="text"
                      value={currentProduct.category}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, category: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      MRP
                    </label>
                    <input
                      type="number"
                      value={currentProduct.mrp}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, mrp: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Selling Price
                    </label>
                    <input
                      type="number"
                      value={currentProduct.selling_price}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, selling_price: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      HSN Code
                    </label>
                    <input
                      type="text"
                      value={currentProduct.hsn_code}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, hsn_code: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      GST Rate
                    </label>
                    <input
                      type="number"
                      value={currentProduct.gst_rate}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, gst_rate: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Alias
                    </label>
                    <input
                      type="text"
                      value={currentProduct.alias}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, alias: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Part Number
                    </label>
                    <input
                      type="text"
                      value={currentProduct.part_number}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, part_number: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Stock Group
                    </label>
                    <input
                      type="text"
                      value={currentProduct.stock_group}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, stock_group: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Unit of Measure
                    </label>
                    <select
                      value={currentProduct.unit_of_measure}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, unit_of_measure: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    >
                      <option value="">Select Unit</option>
                      <option value="PCS">Pieces</option>
                      <option value="KG">Kilograms</option>
                      <option value="LTR">Liters</option>
                      <option value="BOX">Box</option>
                      <option value="PKT">Packet</option>
                      <option value="SET">Set</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Maintain Batches
                    </label>
                    <select
                      value={currentProduct.maintain_batches}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, maintain_batches: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    >
                      <option value="">Select Option</option>
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Stock Quantity
                    </label>
                    <input
                      type="number"
                      value={currentProduct.stock_quantity}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, stock_quantity: e.target.value })
                      }
                      className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Type of Supply *
                    </label>
                    <select
                      value={currentProduct.type_of_supply}
                      onChange={(e) =>
                        setCurrentProduct({ ...currentProduct, type_of_supply: e.target.value })
                      }
                      className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors ${errors.type_of_supply ? 'border-red-500' : ''}`}
                      required
                    >
                      <option value="">Select Type of Supply</option>
                      <option value="Goods">Goods</option>
                      <option value="Services">Services</option>
                    </select>
                    {errors.type_of_supply && (
                      <p className="mt-1 text-sm text-red-600">{errors.type_of_supply}</p>
                    )}
                  </div>
                </div>
                <div className="flex justify-end space-x-3 pt-6">
                  <button
                    type="button"
                    onClick={() => {
                      setShowProductEditModal(false);
                      setErrors({});
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 text-sm font-medium text-white bg-[#003366] hover:bg-[#002244] rounded-lg transition-colors"
                  >
                    Update Product
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        {/* Change Image Modal */}
        {showImageChangeModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
              <h3 className="text-xl font-semibold text-[#003366] mb-6">
                Change Product Image
              </h3>
              <form onSubmit={handleImageChange} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Product Image
                  </label>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleImageFilesChange}
                    className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                  />
                </div>
                {currentProduct.image && (
                  <div className="mt-2">
                    <p className="text-sm text-gray-600">Current Image:</p>
                    <img
                      src={getImageUrl(currentProduct.image)}
                      alt="Current product"
                      className="mt-2 h-32 object-contain border rounded"
                      onError={(e) => {
                        console.error(`Failed to load image for ${currentProduct.name}:`, e);
                        e.target.onerror = null;
                        e.target.src = placeholderImage;
                      }}
                    />
                  </div>
                )}
                <div className="flex justify-end space-x-3">
                  <button
                    type="button"
                    onClick={() => {
                      setShowImageChangeModal(false);
                      setImageFiles({});
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 text-sm font-medium text-white bg-[#003366] hover:bg-[#002244] rounded-lg transition-colors"
                  >
                    Update Image
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        {/* Bulk Upload Modal */}
        {showBulkUploadModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
              <h3 className="text-xl font-semibold text-[#003366] mb-6">
                Bulk Upload Products
              </h3>
              <form onSubmit={handleBulkUpload} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Excel File
                  </label>
                  <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={(e) => {
                      const file = e.target.files[0];
                      if (file) {
                        setExcelFile(file);
                      }
                    }}
                    className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-[#003366] focus:ring-[#003366] transition-colors"
                  />
                  <p className="mt-1 text-sm text-gray-500">
                    Upload Excel file with product details and image paths (local or URL)
                  </p>
                </div>
                <div className="flex justify-between items-center">
                  <button
                    type="button"
                    onClick={downloadTemplate}
                    className="text-[#003366] hover:underline text-sm"
                  >
                    Download Template
                  </button>
                </div>
                <div className="flex justify-end space-x-3">
                  <button
                    type="button"
                    onClick={() => {
                      setShowBulkUploadModal(false);
                      setExcelFile(null);
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    disabled={uploading}
                    className="px-4 py-2 text-sm font-medium text-white bg-[#003366] hover:bg-[#002244] rounded-lg transition-colors disabled:opacity-50"
                  >
                    {uploading ? "Uploading..." : "Upload Products"}
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}